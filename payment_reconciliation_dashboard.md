# Payment Reconciliation Dashboard

## Overview

This document outlines the payment reconciliation dashboard system implemented for BenPharma. The system provides comprehensive monitoring, analytics, and reconciliation capabilities for all payment transactions.

## Database Views Created

### 1. `payment_daily_summary`
Provides daily aggregated payment statistics by method and status.

```sql\nSELECT * FROM payment_daily_summary \nWHERE payment_date >= CURRENT_DATE - INTERVAL '7 days'\nORDER BY payment_date DESC;\n```

**Columns:**\n- `payment_date` - Date of transactions\n- `payment_method` - Payment gateway used\n- `payment_status` - Transaction status\n- `transaction_count` - Number of transactions\n- `total_amount` - Sum of all transaction amounts\n- `completed_amount` - Sum of successful transactions\n- `failed_amount` - Sum of failed transactions\n- `pending_amount` - Sum of pending transactions\n- `average_amount` - Average transaction amount\n- `total_gateway_fees` - Total gateway fees\n- `total_app_fees` - Total application fees\n\n### 2. `payment_method_performance`\nAnalyzes performance metrics for each payment method.\n\n```sql\nSELECT * FROM payment_method_performance\nORDER BY success_rate_percentage DESC;\n```\n\n**Key Metrics:**\n- Success rate percentage\n- Transaction volume\n- Average processing time\n- Retry statistics\n- Fee analysis\n\n### 3. `payment_reconciliation_status`\nIdentifies discrepancies between payments and orders.\n\n```sql\n-- Find unreconciled transactions\nSELECT * FROM payment_reconciliation_status \nWHERE reconciliation_status != 'RECONCILED'\nORDER BY amount_difference DESC;\n```\n\n**Reconciliation Types:**\n- `RECONCILED` - Payment and order match perfectly\n- `AMOUNT_MISMATCH` - Payment amount differs from order total\n- `STATUS_MISMATCH` - Payment status doesn't match order payment status\n\n### 4. `failed_payments_analysis`\nDetailed analysis of failed payment transactions.\n\n```sql\n-- Analyze failed payments by method\nSELECT \n  method,\n  COUNT(*) as failed_count,\n  AVG(failure_time_minutes) as avg_failure_time,\n  SUM(CASE WHEN retry_status = 'RETRY_SCHEDULED' THEN 1 ELSE 0 END) as retries_scheduled\nFROM failed_payments_analysis\nGROUP BY method;\n```\n\n### 5. `customer_payment_patterns`\nAnalyzes customer payment behavior and success patterns.\n\n```sql\n-- Find customers with low success rates\nSELECT * FROM customer_payment_patterns \nWHERE success_rate < 80 AND total_payments > 3\nORDER BY total_spent DESC;\n```\n\n## Dashboard Functions\n\n### `get_payment_dashboard_metrics(days_back)`\nReturns comprehensive dashboard metrics in JSON format.\n\n```sql\n-- Get last 7 days metrics\nSELECT get_payment_dashboard_metrics(7);\n```\n\n**Example Output:**\n```json\n{\n  \"total_transactions\": 150,\n  \"total_volume\": 425000.00,\n  \"successful_transactions\": 142,\n  \"success_rate\": 94.67,\n  \"pending_transactions\": 3,\n  \"failed_transactions\": 5,\n  \"total_fees\": 8500.00,\n  \"reconciliation_issues\": 2\n}\n```\n\n## Payment Retry System\n\n### Configuration Table: `payment_retry_config`\nDefines retry behavior for each payment method:\n\n| Payment Method | Max Retries | Retry Delays (seconds) | Notes |\n|----------------|-------------|------------------------|-------|\n| FLUTTERWAVE | 3 | [300, 900, 3600] | 5min, 15min, 1hr |\n| PAYSTACK | 3 | [300, 900, 3600] | 5min, 15min, 1hr |\n| OPAY | 2 | [600, 1800] | 10min, 30min |\n| BANK_TRANSFER | 1 | [86400] | 24 hours |\n| CASH_ON_DELIVERY | 0 | [] | No retries |\n\n### Retry Functions\n\n**Schedule a retry:**\n```sql\nSELECT schedule_payment_retry('payment_id_here');\n```\n\n**Get pending retries:**\n```sql\nSELECT * FROM get_pending_payment_retries();\n```\n\n## Dashboard Implementation Guide\n\n### Frontend Implementation\n\n1. **Main Dashboard Cards**\n```javascript\n// Fetch dashboard metrics\nconst metrics = await supabase\n  .rpc('get_payment_dashboard_metrics', { days_back: 7 });\n```\n\n2. **Daily Transaction Chart**\n```javascript\nconst dailyData = await supabase\n  .from('payment_daily_summary')\n  .select('*')\n  .gte('payment_date', sevenDaysAgo)\n  .order('payment_date', { ascending: true });\n```\n\n3. **Payment Method Performance**\n```javascript\nconst methodPerformance = await supabase\n  .from('payment_method_performance')\n  .select('*')\n  .order('success_rate_percentage', { ascending: false });\n```\n\n4. **Reconciliation Issues**\n```javascript\nconst issues = await supabase\n  .from('payment_reconciliation_status')\n  .select('*')\n  .neq('reconciliation_status', 'RECONCILED')\n  .order('amount_difference', { ascending: false });\n```\n\n### Key Performance Indicators (KPIs)\n\n1. **Transaction Volume**\n   - Daily/Weekly/Monthly transaction counts\n   - Transaction value trends\n   - Average transaction size\n\n2. **Success Metrics**\n   - Overall success rate\n   - Success rate by payment method\n   - Success rate by customer type\n\n3. **Financial Metrics**\n   - Total processing fees\n   - Revenue by payment method\n   - Failed transaction losses\n\n4. **Operational Metrics**\n   - Average processing time\n   - Retry effectiveness\n   - Reconciliation accuracy\n\n### Alerting Recommendations\n\n**Critical Alerts:**\n- Success rate drops below 90%\n- Transaction volume drops by >50%\n- More than 10 unreconciled transactions\n\n**Warning Alerts:**\n- Success rate drops below 95%\n- Gateway fees exceed expected thresholds\n- Processing times exceed 5 minutes\n\n### Reports to Generate\n\n1. **Daily Reconciliation Report**\n2. **Weekly Payment Method Performance Report**\n3. **Monthly Customer Behavior Analysis**\n4. **Failed Payment Investigation Report**\n5. **Gateway Cost Analysis Report**\n\n## Monitoring Queries\n\n### Real-time Health Check\n```sql\n-- Check for recent issues\nSELECT \n  'Unreconciled Payments' as issue_type,\n  COUNT(*) as count\nFROM payment_reconciliation_status \nWHERE reconciliation_status != 'RECONCILED'\n  AND payment_created >= NOW() - INTERVAL '1 day'\n\nUNION ALL\n\nSELECT \n  'Failed Payments (Last Hour)' as issue_type,\n  COUNT(*) as count\nFROM payment \nWHERE status = 'FAILED' \n  AND \"createdAt\" >= NOW() - INTERVAL '1 hour';\n```\n\n### Performance Monitoring\n```sql\n-- Check payment processing times\nSELECT \n  method,\n  AVG(EXTRACT(EPOCH FROM (\"updatedAt\" - \"createdAt\"))) / 60 as avg_minutes,\n  MAX(EXTRACT(EPOCH FROM (\"updatedAt\" - \"createdAt\"))) / 60 as max_minutes\nFROM payment \nWHERE \"createdAt\" >= NOW() - INTERVAL '24 hours'\n  AND status = 'COMPLETED'\nGROUP BY method\nORDER BY avg_minutes DESC;\n```\n\n## Security Considerations\n\n- All views respect existing RLS policies\n- Dashboard functions use SECURITY DEFINER with limited privileges\n- Sensitive payment data is properly protected\n- Access logging for audit compliance\n\n## Next Steps\n\n1. Implement frontend dashboard using the views and functions\n2. Set up automated reporting schedules\n3. Configure alerting based on KPI thresholds\n4. Add real-time WebSocket updates for live monitoring\n5. Integrate with business intelligence tools if needed\n\n---\n\n*This dashboard provides comprehensive visibility into the payment system's health, performance, and accuracy, enabling proactive monitoring and quick resolution of issues.*
